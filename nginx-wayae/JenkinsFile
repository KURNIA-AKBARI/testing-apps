node {
    try {
        stage ('Jenkins Jobs Triggered'){
            echo "Pipeline Start ..."
        }
        
        stage('Get Source from SCM') {
            stage = 'Get Source from SCM'
            git branch: "master",
            credentialsId: 'kurnia_akbari',
            url: 'https://github.com/KURNIA-AKBARI/testing-apps.git'
            
        }
        stage('Create Docker Containers & Pushing') {
            stage = 'Create Docker Containers & Pushing'
            dir ('target'){
                script {
          sh "docker -v"
                    sh "pwd"
          sh "docker build -t https://hub.docker.com/repository/docker/kurniaakbarialdianza/testerapps:alpha ."
                    docker.withRegistry('https://hub.docker.com/u/kurniaakbarialdianza', 'Docker.Hub') {
                    sh "docker push kurniaakbarialdianza/testerapps:alpha"
          }
        }
      }
    }
    stage ('Deploy to Kubernetes'){
            stage = 'Deploy to Kubernetes'
            script {
        withKubeConfig(credentialsId: 'cluster_w', serverUrl: 'https://192.168.100.130:6443'){
          sh 'kubectl apply -f deployment-nginx.yaml'
                    sh 'kubectl apply -f service-nginx.yaml'
                    sh 'kubectl apply -f ingress-nginx.yaml'
                }
            }
    }
                
        stage ('Notification') {
            stage = 'Notification'
            sh "curl -s -X POST https://api.telegram.org/bot702898762:AAGrLYF_keCzywv9nLMAwoxaOedXrH1ZdoE/sendMessage -d chat_id=-45715203 -d text='Deployment ${env.JOB_NAME} Berhasil'"
        }
        
        catch (e) {
            sh "curl -s -X POST https://api.telegram.org/bot702898762:AAGrLYF_keCzywv9nLMAwoxaOedXrH1ZdoE/sendMessage -d chat_id=-45715203 -d text='Deployment ${env.JOB_NAME} Gagal Pada Stage ${stage}'"
    }